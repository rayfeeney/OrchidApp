CREATE PROCEDURE `spMovePlantToLocation`(\n    IN pPlantId INT,\n    IN pLocationId INT,\n    IN pStartDate DATE,\n--    IN pMoveReasonCode VARCHAR(30),\n    IN pMoveReasonNotes VARCHAR(500),\n    IN pPlantLocationNotes VARCHAR(500)\n)\nBEGIN\n    DECLARE vStart DATETIME;\n    DECLARE vNow DATETIME;\n\n    DECLARE vCurrentId INT;\n    DECLARE vCurrentLocationId INT;\n    DECLARE vCurrentStart DATETIME;\n\n    DECLARE vLatestPoint DATETIME;\n    DECLARE vOverlapCount INT;\n\n    SET vNow = NOW();\n    SET vStart = TIMESTAMP(DATE(pStartDate), TIME(vNow));\n\n    /* ---------- Guards ---------- */\n\n    IF NOT EXISTS (SELECT 1 FROM plant WHERE plantId = pPlantId) THEN\n        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'PlantId does not exist.';\n    END IF;\n\n    IF NOT EXISTS (SELECT 1 FROM location WHERE locationId = pLocationId) THEN\n        SIGNAL SQLSTATE '45000' SET MESSAGE_TEXT = 'LocationId does not exist.';\n    END IF;\n\n    /* Current active open row */\n    SELECT plantLocationHistoryId, locationId, startDateTime\n      INTO vCurrentId, vCurrentLocationId, vCurrentStart\n    FROM plantlocationhistory\n    WHERE plantId = pPlantId\n      AND isActive = 1\n      AND endDateTime IS NULL\n    LIMIT 1;\n\n    IF vCurrentId IS NOT NULL AND vCurrentLocationId = pLocationId THEN\n        SIGNAL SQLSTATE '45000'\n            SET MESSAGE_TEXT = 'Plant is already in this location.';\n    END IF;\n\n    IF vCurrentId IS NOT NULL AND vStart < vCurrentStart THEN\n        SIGNAL SQLSTATE '45000'\n            SET MESSAGE_TEXT = 'Move start cannot be earlier than current location start.';\n    END IF;\n\n    SELECT MAX(COALESCE(endDateTime, startDateTime))\n      INTO vLatestPoint\n    FROM plantlocationhistory\n    WHERE plantId = pPlantId\n      AND isActive = 1;\n\n    IF vLatestPoint IS NOT NULL AND vStart < vLatestPoint THEN\n        SIGNAL SQLSTATE '45000'\n            SET MESSAGE_TEXT = 'Move would backdate into existing history.';\n    END IF;\n\n    SELECT COUNT(*) INTO vOverlapCount\n    FROM plantlocationhistory\n    WHERE plantId = pPlantId\n      AND isActive = 1\n      AND plantLocationHistoryId <> COALESCE(vCurrentId, -1)\n      AND startDateTime < vStart\n      AND COALESCE(endDateTime, '9999-12-31') > vStart;\n\n    IF vOverlapCount > 0 THEN\n        SIGNAL SQLSTATE '45000'\n            SET MESSAGE_TEXT = 'Move would overlap existing history.';\n    END IF;\n\n    /* ---------- Transaction ---------- */\n\n    START TRANSACTION;\n\n        IF vCurrentId IS NOT NULL THEN\n            UPDATE plantlocationhistory\n            SET endDateTime = vStart\n            WHERE plantLocationHistoryId = vCurrentId\n              AND isActive = 1\n              AND endDateTime IS NULL;\n        END IF;\n\n        INSERT INTO

