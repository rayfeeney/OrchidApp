CREATE PROCEDURE `spRemovePlantLocation`(\n    IN pPlantLocationHistoryId INT\n)\nBEGIN\n    DECLARE vPlantId INT;\n    DECLARE vStart DATETIME;\n    DECLARE vEnd DATETIME;\n    DECLARE vIsCurrent TINYINT;\n\n    DECLARE vPrevId INT;\n    DECLARE vNextId INT;\n\n    START TRANSACTION;\n\n        /* ---------- Load target (locked) ---------- */\n\n        SELECT plantId, startDateTime, endDateTime\n          INTO vPlantId, vStart, vEnd\n        FROM plantlocationhistory\n        WHERE plantLocationHistoryId = pPlantLocationHistoryId\n          AND isActive = 1\n        FOR UPDATE;\n\n        IF vPlantId IS NULL THEN\n            SIGNAL SQLSTATE '45000'\n                SET MESSAGE_TEXT = 'Active location history row not found.';\n        END IF;\n\n        SET vIsCurrent = IF(vEnd IS NULL, 1, 0);\n\n        /* ---------- Guard: previous ambiguity ---------- */\n\n        IF (\n            SELECT COUNT(*)\n            FROM plantlocationhistory\n            WHERE plantId = vPlantId\n              AND isActive = 1\n              AND endDateTime = vStart\n        ) > 1 THEN\n            SIGNAL SQLSTATE '45000'\n                SET MESSAGE_TEXT = 'Ambiguous previous location during removal.';\n        END IF;\n\n        SELECT plantLocationHistoryId\n          INTO vPrevId\n        FROM plantlocationhistory\n        WHERE plantId = vPlantId\n          AND isActive = 1\n          AND endDateTime = vStart\n        LIMIT 1;\n\n        /* ---------- Guard: next ambiguity ---------- */\n\n        IF vIsCurrent = 0 AND (\n            SELECT COUNT(*)\n            FROM plantlocationhistory\n            WHERE plantId = vPlantId\n              AND isActive = 1\n              AND startDateTime = vEnd\n        ) > 1 THEN\n            SIGNAL SQLSTATE '45000'\n                SET MESSAGE_TEXT = 'Ambiguous next location during removal.';\n        END IF;\n\n        IF vIsCurrent = 0 THEN\n            SELECT plantLocationHistoryId\n              INTO vNextId\n            FROM plantlocationhistory\n            WHERE plantId = vPlantId\n              AND isActive = 1\n              AND startDateTime = vEnd\n            LIMIT 1;\n        END IF;\n\n        /* ---------- Re-stitch ---------- */\n\n        UPDATE plantlocationhistory\n        SET isActive = 0\n        WHERE plantLocationHistoryId = pPlantLocationHistoryId;\n        \n        IF vIsCurrent = 1 THEN\n            IF vPrevId IS NOT NULL THEN\n                UPDATE plantlocationhistory\n                SET endDateTime = NULL\n                WHERE plantLocationHistoryId = vPrevId;\n            END IF;\n        ELSE\n            IF vPrevId IS NOT NULL AND vNextId IS NOT NULL THEN\n                UPDATE plantlocationhistory\n                SET endDateTime = vEnd\n                WHERE plantLocationHistoryId = vPrevId;\n            END IF;\n        END IF;\n\n        /* ---------- Post-invariant ---------- */\n\n        IF (\n            SELECT COUNT(*)\n            FROM plantlocationhistory\n            WHERE plantId = vPlantId\n              AND isActive = 1\n              AND endDateTime IS NULL\n        ) > 1 THEN\n            SIGNAL SQLSTATE '45000'\n                SET MESSAGE_TEXT = 'Invariant violation after location removal.';\n        END IF;\n\n    COMMIT;\nEND	ut

