CREATE VIEW `vplantlifecyclehistory` AS with `plant_identity` as (select `p`.`plantId` AS `plantId` from `plant` `p` where (`p`.`isActive` = 1)) select `pi`.`plantId` AS `plantId`,`pe`.`eventDateTime` AS `eventDateTime`,'Observation' AS `eventType`,`pe`.`eventDetails` AS `eventSummary`,'plantevent' AS `sourceTable`,`pe`.`plantEventId` AS `sourceId` from (`plant_identity` `pi` join `plantevent` `pe` on((`pe`.`plantId` = `pi`.`plantId`))) where (`pe`.`isActive` = 1) union all select `pi`.`plantId` AS `plantId`,cast(`r`.`repotDate` as datetime) AS `eventDateTime`,'Repotting' AS `eventType`,concat('Repotted',(case when ((`r`.`oldMediumCode` is not null) and (`r`.`newMediumCode` is not null)) then concat(' from ',`r`.`oldMediumCode`,' to ',`r`.`newMediumCode`) when (`r`.`oldMediumCode` is not null) then concat(' from ',`r`.`oldMediumCode`) when (`r`.`newMediumCode` is not null) then concat(' into ',`r`.`newMediumCode`) else '' end),(case when (coalesce(nullif(`r`.`repottingNotes`,''),nullif(`r`.`repotReasonNotes`,''),nullif(`r`.`newMediumNotes`,''),nullif(`r`.`oldMediumNotes`,'')) is not null) then concat(' ÔÇö ',coalesce(nullif(`r`.`repottingNotes`,''),nullif(`r`.`repotReasonNotes`,''),nullif(`r`.`newMediumNotes`,''),nullif(`r`.`oldMediumNotes`,''))) else '' end)) AS `eventSummary`,'repotting' AS `sourceTable`,`r`.`repottingId` AS `sourceId` from (`plant_identity` `pi` join `repotting` `r` on((`r`.`plantId` = `pi`.`plantId`))) where (`r`.`isActive` = 1) union all select `pi`.`plantId` AS `plantId`,cast(`f`.`startDate` as datetime) AS `eventDateTime`,'Flowering' AS `eventType`,concat('Flowered',(case when ((`f`.`startDate` is not null) and (`f`.`endDate` is not null)) then concat(' from ',date_format(`f`.`startDate`,'%d-%m-%Y'),' to ',date_format(`f`.`endDate`,'%d-%m-%Y')) when ((`f`.`startDate` is not null) and (`f`.`endDate` is null)) then concat(' from ',date_format(`f`.`startDate`,'%d-%m-%Y'),' (currently flowering)') else '' end),(case when ((`f`.`flowerCount` is not null) and (`f`.`spikeCount` is not null)) then concat(' with ',(case when (`f`.`flowerCount` = 1) then '1 flower' else concat(`f`.`flowerCount`,' flowers') end),' over ',(case when (`f`.`spikeCount` = 1) then '1 spike' else concat(`f`.`spikeCount`,' spikes') end)) when (`f`.`flowerCount` is not null) then concat(' with ',(case when (`f`.`flowerCount` = 1) then '1 flower' else concat(`f`.`flowerCount`,' flowers') end)) when (`f`.`spikeCount` is not null) then concat(' over ',(case when (`f`.`spikeCount` = 1) then '1 spike' else concat(`f`.`spikeCount`,' spikes') end)) else '' end),(case when ((`f`.`floweringNotes` is not null) and (`f`.`floweringNotes` <> '')) then concat(' ÔÇö ',`f`.`floweringNotes`) else '' end)) AS `eventSummary`,'flowering' AS `sourceTable`,`f`.`floweringId` AS `sourceId` from (`plant_identity` `pi` join `flowering` `f` on((`f`.`plantId` = `pi`.`plantId`))) where (`f`.`isActive` = 1) union all select `pi`.`plantId` AS `plantId`,`plh`.`startDateTime` AS `eventDateTime`,'LocationChange' AS `eventType`,concat('Moved to ',`l`.`locationName`,' on ',date_format(`plh`.`startDateTime`,'%d-%m-%Y'),(case when (`plh`.`endDateTime` is not null) then concat(' to ',date_format(`plh`.`endDateTime`,'%d-%m-%Y')) else ' (current)' end),(case when ((`plh`.`moveReasonNotes` is not null) and (`plh`.`moveReasonNotes` <> '')) then concat(' : ',`plh`.`moveReasonNotes`) else '' end),(case when ((`plh`.`plantLocationNotes` is not null) and (`plh`.`plantLocationNotes` <> '')) then concat(' - ',`plh`.`plantLocationNotes`) else '' end)) AS `eventSummary`,'plantlocationhistory' AS `sourceTable`,`plh`.`plantLocationHistoryId` AS `sourceId` from ((`plant_identity` `pi` join `plantlocationhistory` `plh` on((`plh`.`plantId` = `pi`.`plantId`))) join `location` `l` on((`l`.`locationId` = `plh`.`locationId`))) where (`plh`.`isActive` = 1);

